<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo - ANTT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a; 
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-orange: #f97316;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 50px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* HEADER */
        header { text-align: center; margin-bottom: 30px; padding: 20px 0; border-bottom: 1px solid #334155; }
        header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        header p { color: var(--text-muted); }

        /* BOTÃO SWAGGER */
        .swagger-btn {
            display: block; margin: 0 auto 30px; padding: 14px 36px;
            font-size: 1.15rem; font-weight: 600; color: #fff;
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            border: none; border-radius: 10px; cursor: pointer; text-decoration: none; text-align: center;
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3); transition: all 0.3s ease; max-width: 420px;
        }
        .swagger-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4); }
        .swagger-btn small { display: block; margin-top: 8px; font-size: 0.85rem; opacity: 0.9; }

        /* LAYOUT */
        .section-header {
            display: flex; align-items: center; margin: 40px 0 20px 0; font-size: 1.4rem; font-weight: 600;
            border-left: 5px solid var(--accent-blue); padding-left: 15px;
        }
        .section-header.danger { border-color: var(--accent-red); color: var(--accent-red); }
        .section-header.warn { border-color: var(--accent-orange); color: var(--accent-orange); }

        .grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .grid-analysis { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }

        /* CARDS */
        .card { background: var(--bg-card); border-radius: 12px; padding: 25px; border: 1px solid #334155; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        
        .kpi-box { text-align: center; padding: 20px; position: relative; overflow: hidden; }
        .kpi-box h3 { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
        .kpi-box p { font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }
        .kpi-box i { position: absolute; top: 10px; right: 10px; font-size: 3rem; opacity: 0.05; }

        .narrative h4 { font-size: 1.1rem; margin-bottom: 15px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .narrative p { font-size: 0.95rem; line-height: 1.6; color: #cbd5e1; margin-bottom: 15px; }
        .highlight-red { color: var(--accent-red); font-weight: bold; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        td { padding: 10px 0; border-bottom: 1px solid #334155; color: #f1f5f9; }
        .bar-container { background: #334155; height: 6px; border-radius: 3px; width: 100%; margin-top: 5px; }
        .bar-fill { height: 100%; border-radius: 3px; background: var(--accent-red); }

        /* BADGES */
        .badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; margin: 4px 4px 4px 0; }
        .badge-danger { background: #7f1d1d; color: #fca5a5; }
        .badge-warning { background: #78350f; color: #fcd34d; }
        .badge-info { background: #0c4a6e; color: #7dd3fc; }
        .badge-success { background: #064e3b; color: #86efac; }

        @media (max-width: 900px) { .grid-analysis { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Panorama de Segurança e Infraestrutura</h1>
        <p>Análise de Riscos baseada nos dados do documento ANTT_Valor 2025</p>
    </header>

    <a href="/swagger" class="swagger-btn">
        ABRIR SWAGGER API
        <small>Documentação Técnica e Testes (Key: antt2025)</small>
    </a>

    <div class="section-header"><i class="fas fa-users-cog me-2"></i> 1. Gestão de Identidade e Acessos</div>
    
    <div class="grid-kpi">
        <div class="card kpi-box">
            <p>Total de Usuários</p>
            <h3 id="kpi-users">--</h3>
            <i class="fas fa-users"></i>
        </div>
        <div class="card kpi-box" style="border-bottom: 4px solid var(--accent-red)">
            <p>Usuários Desabilitados</p>
            <h3 id="kpi-disabled" style="color: var(--accent-red)">--</h3>
            <i class="fas fa-user-slash"></i>
        </div>
        <div class="card kpi-box">
            <p>Admins Ativos</p>
            <h3 id="kpi-admins">--</h3>
            <i class="fas fa-user-shield"></i>
        </div>
        <div class="card kpi-box">
            <p>Contas de Serviço</p>
            <h3 id="kpi-service">--</h3>
            <i class="fas fa-robot"></i>
        </div>
    </div>

    <div class="grid-analysis">
        <div class="card">
            <canvas id="chartADEvo" height="120"></canvas>
        </div>
        <div class="card narrative">
            <h4><i class="fas fa-info-circle"></i> Análise de Higiene</h4>
            <p id="txt-ad-analysis">Carregando...</p>
            <p id="txt-admin-analysis"></p>
        </div>
    </div>

    <div class="section-header danger"><i class="fas fa-shield-alt me-2"></i> 2. Ameaças e Incidentes</div>

    <div class="grid-analysis">
        <div class="card">
            <h4 style="margin-bottom:15px; font-size:1rem; color:var(--text-muted)">Volume de Alertas (Timeline)</h4>
            <canvas id="chartAlertsTime" height="100"></canvas>
        </div>
        <div class="card narrative">
            <h4 style="color: var(--accent-red)"><i class="fas fa-fire"></i> Focos de Incêndio</h4>
            <p id="txt-security-analysis">Carregando...</p>
            <div id="security-checks" style="margin-top:12px; font-size:0.95rem; color:#cbd5e1"></div>
        </div>
    </div>

    <div class="grid-kpi">
        <div class="card">
            <h5 style="color:var(--text-muted); margin-bottom:15px">TOP USUÁRIOS ALVO</h5>
            <table id="table-users"></table>
        </div>
        <div class="card">
            <h5 style="color:var(--text-muted); margin-bottom:15px">TOP AMEAÇAS</h5>
            <table id="table-threats"></table>
        </div>
    </div>

    <div class="section-header"><i class="fas fa-map-marked-alt me-2"></i> 4. Mapa de Vulnerabilidade do AD & Exposição</div>

    <div class="grid-analysis">
        <div class="card">
            <h4 style="margin-bottom:12px; color:var(--text-muted)">Mapa de Vulnerabilidade (domínios)</h4>
            <table id="table-vuln"></table>
        </div>
        <div class="card">
            <h4 style="margin-bottom:12px; color:var(--text-muted)">Exposição de Dados (por servidor)</h4>
            <div style="font-size:1.5rem; margin-bottom:10px">Score: <span id="kpi-exposure">--</span></div>
            <table id="table-exposure"></table>
        </div>
    </div>

    <div class="section-header warn"><i class="fas fa-server me-2"></i> 3. Governança de Dados</div>

    <div class="grid-analysis">
        <div class="card" style="display:flex; justify-content:center;">
            <div style="width: 250px;"><canvas id="chartStale"></canvas></div>
        </div>
        <div class="card narrative">
            <h4><i class="fas fa-database"></i> Dados Parados vs. Ativos</h4>
            <p id="txt-gov-analysis">Carregando...</p>
        </div>
    </div>

</div>

<script>
    // Função segura para formatar números
    const fmt = (n) => n ? n.toLocaleString('pt-BR') : '0';

    async function loadDashboard() {
        try {
            console.log("1. Iniciando fetch...");
            const resp = await fetch('/api/v1/dashboard_data');
            
            if(!resp.ok) throw new Error(`Erro HTTP: ${resp.status}`);
            
            const data = await resp.json();
            console.log("2. Dados recebidos com sucesso:", data);

            // === ATUALIZAR TEXTOS E KPIs (Blindado contra falha de gráficos) ===
            
            // AD
            if (data.ad_health && data.ad_health.latest) {
                const ad = data.ad_health.latest;
                document.getElementById('kpi-users').innerText = fmt(ad.users_total);
                document.getElementById('kpi-disabled').innerText = fmt(ad.users_disabled);
                document.getElementById('kpi-admins').innerText = fmt(ad.admins_active);

                const disabledText = (ad.disabled_pct > 50) 
                    ? `O ambiente apresenta <span class="highlight-red">${ad.disabled_pct}%</span> de contas desabilitadas. Um número alto (acima de 50%) polui a gestão.`
                    : `O ambiente apresenta ${ad.disabled_pct}% de contas desabilitadas, nível aceitável.`;
                
                document.getElementById('txt-ad-analysis').innerHTML = disabledText;
                document.getElementById('txt-admin-analysis').innerHTML = `Admins Ativos: <b>${ad.admins_active}</b>. Atenção ao acúmulo de privilégios.`;
                    // Contas de serviço (se disponíveis)
                    if (ad.service_accounts !== undefined) {
                        document.getElementById('kpi-service').innerText = fmt(ad.service_accounts);
                    }
            }

            // SEGURANÇA
            if (data.security) {
                const sec = data.security;
                const secText = sec.total_alerts > 0
                    ? `Detectados <span class="highlight-red">${sec.total_alerts}</span> alertas ativos. Verifique os ofensores abaixo.`
                    : "Nenhum alerta crítico detectado.";
                // Acrescenta indicadores importantes: exclusões/desativações, acesso a ferramentas admin, indícios de ransomware
                let extra = [];
                if (sec.admin_deletions) extra.push(`<b>${sec.admin_deletions}</b> exclusões/desativações administrativas`);
                if (sec.admin_tool_access) extra.push(`<b>${sec.admin_tool_access}</b> acessos a ferramentas administrativas detectados`);
                if (sec.ransomware_indicators) extra.push(`<b>${sec.ransomware_indicators}</b> indícios de ransomware`);

                document.getElementById('txt-security-analysis').innerHTML = secText + (extra.length ? '<br><small style="color:#f8d7da;">' + extra.join(' · ') + '</small>' : '');

                // Tabelas
                const userTable = document.getElementById('table-users');
                if(sec.top_users) {
                    userTable.innerHTML = ''; // Limpa
                    Object.entries(sec.top_users).forEach(([user, count]) => {
                        const pct = Math.min((count/20)*100, 100);
                        userTable.innerHTML += `<tr><td width="40%">${user}</td><td width="60%"><div style="display:flex;align-items:center;gap:10px;"><div class="bar-container"><div class="bar-fill" style="width:${pct}%"></div></div><b>${count}</b></div></td></tr>`;
                    });
                }

                const threatTable = document.getElementById('table-threats');
                if(sec.top_threats) {
                    threatTable.innerHTML = ''; // Limpa
                    Object.entries(sec.top_threats).forEach(([threat, count]) => {
                        threatTable.innerHTML += `<tr><td>${threat.substring(0,25)}...</td><td style="text-align:right;font-weight:bold;color:#ef4444">${count}</td></tr>`;
                    });
                }

                // Preenche tabela de vulnerabilidade e exposição caso disponíveis
                if (data.ad_vulnerability_map) {
                    const tv = document.getElementById('table-vuln');
                    tv.innerHTML = '<tr><td><b>Domínio</b></td><td style="text-align:right"><b>Score</b></td></tr>';
                    data.ad_vulnerability_map.forEach(item => {
                        tv.innerHTML += `<tr><td>${item.domain}</td><td style="text-align:right;color:${item.vuln_score>70?'#ef4444':'#fff'}">${item.vuln_score} (${item.disabled_pct}% desab, ${item.admins} admins)</td></tr>`;
                    });
                }

                if (data.data_exposure) {
                    document.getElementById('kpi-exposure').innerText = data.data_exposure.exposure_score;
                    const te = document.getElementById('table-exposure');
                    te.innerHTML = '<tr><td><b>Servidor</b></td><td style="text-align:right"><b>Exposição</b></td></tr>';
                    (data.data_exposure.servers||[]).forEach(s => {
                        te.innerHTML += `<tr><td>${s.server}</td><td style="text-align:right">${s.exposure_score} (${fmt(s.permission_entries)} perm)</td></tr>`;
                    });
                }

                // Preenche verificações extras (Varonis / AD health) quando disponíveis
                try {
                    const checks = [];
                    if (data.varonis && data.varonis.events) {
                        const remediation = data.varonis.remediation_needed ? '<span class="badge badge-danger">Remediação necessária</span>' : '';
                        checks.push(`<div style="margin-bottom:8px"><span class="badge badge-warning">Varonis Events: ${data.varonis.events}</span> ${remediation}</div>`);
                    }
                    if (data.vulnerabilities) {
                        if (data.vulnerabilities.enable_but_stale > 0) {
                            checks.push(`<div style="margin-bottom:8px"><span class="badge badge-warning">Enable but Stale: ${data.vulnerabilities.enable_but_stale}</span></div>`);
                        }
                        if (data.vulnerabilities.executive_accounts > 0) {
                            checks.push(`<div style="margin-bottom:8px"><span class="badge badge-info">Contas Executivas: ${data.vulnerabilities.executive_accounts}</span></div>`);
                        }
                    }
                    if (data.security && data.security.krbtgt_reset_recommended) {
                        checks.push(`<div style="margin-bottom:8px"><span class="badge badge-danger">⚠️ KRBTGT: Redefinição recomendada</span></div>`);
                    }
                    if (data.security && data.security.itsm_integration) {
                        checks.push(`<div style="margin-bottom:8px"><span class="badge badge-success">✓ ITSM: Integração detectada</span></div>`);
                    }
                    if (data.security && data.security.access_antt > 0) {
                        checks.push(`<div style="margin-bottom:8px"><span class="badge badge-info">Acessos ANTT: ${data.security.access_antt}</span></div>`);
                    }
                    if (data.security && data.security['antt_step_meetings'] > 0) {
                        checks.push(`<div style="margin-bottom:8px"><span class="badge badge-info">ANTT STEP: ${data.security['antt_step_meetings']} menções</span></div>`);
                    }
                    if (checks.length) {
                        document.getElementById('security-checks').innerHTML = checks.join('');
                    }
                } catch (e) { console.warn('Erro ao renderizar verificações extras', e); }
            }

            // GOVERNANÇA
            if (data.governance) {
                const gov = data.governance;
                if(gov.storage) {
                    document.getElementById('txt-gov-analysis').innerHTML = `Cerca de <span class="highlight-red">${gov.storage.stale_percent}%</span> dos dados são Stale Data.`;
                }
            }

            // === GRÁFICOS (Com Try/Catch para não travar se Chart.js falhar) ===
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js não foi carregado (Tracking Prevention?). Gráficos não serão exibidos, mas os dados estão acima.");
                return;
            }

            try {
                // Gráfico AD
                if(data.ad_health && data.ad_health.evolution) {
                    new Chart(document.getElementById('chartADEvo'), {
                        type: 'line',
                        data: {
                            labels: data.ad_health.evolution.dates,
                            datasets: [
                                { label: 'Usuários', data: data.ad_health.evolution.users, borderColor: '#3b82f6', tension: 0.3 },
                                { label: 'Desabilitados', data: data.ad_health.evolution.disabled, borderColor: '#ef4444', borderDash: [5,5], tension: 0.3 }
                            ]
                        },
                        options: { responsive: true, plugins: { legend: { labels: { color: '#fff' } } }, scales: { y: { ticks: { color: '#94a3b8' } }, x: { display: false } } }
                    });
                }

                // Gráfico Alertas
                if(data.security && data.security.timeline) {
                    new Chart(document.getElementById('chartAlertsTime'), {
                        type: 'bar',
                        data: {
                            labels: data.security.timeline.labels,
                            datasets: [{ label: 'Alertas', data: data.security.timeline.data, backgroundColor: '#ef4444' }]
                        },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#94a3b8' } } } }
                    });
                }

                // Gráfico Stale
                if(data.governance && data.governance.storage) {
                    new Chart(document.getElementById('chartStale'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Em Uso', 'Parado'],
                            datasets: [{ data: [data.governance.storage.active_tb, data.governance.storage.stale_tb], backgroundColor: ['#3b82f6', '#475569'], borderWidth: 0 }]
                        },
                        options: { responsive: true, plugins: { legend: { labels: { color: '#fff' } } } }
                    });
                }
            } catch (chartErr) {
                console.error("Erro ao renderizar gráficos:", chartErr);
            }

        } catch (err) {
            console.error("ERRO FATAL JS:", err);
            document.getElementById('txt-ad-analysis').innerHTML = `<span style="color:red">Erro ao ler dados: ${err.message}</span>`;
        }
    }
    
    // Inicia
    document.addEventListener("DOMContentLoaded", loadDashboard);
</script>

</body>
</html>